# 2장 느려진 서비스, 어디부터 봐야 할까

## 서버 성능 개선 기초

### 병목 지점

- 순간적으로 모든 사용자 요청에 대한 응답 시간이 심각하게 느려진다.
- 다수의 요청에서 연결 시간 초과와 같은 오류가 발생한다.
- 서버를 재시작하면 일시적으로 해결되다가 다시 응답 시간이 느려지는 현상이 반복된다.
- 트래픽이 줄어들 때까지 심각한 상황이 계속된다.

서버 성능 문제는 주로 DB 연동이나 API 연동 과정에서 발생한다.

### 수직 확장과 수평 확장

수직 확장<sup>scale-up</sup>: CPU, 메모리, 디스크 등의 자원을 증가시키는 것  
수평 확장<sup>scale-out</sup>: 서버를 늘리는 것  

```text
로드 밸런서

서버가 두 대 이상이면 로드 밸런서가 필요하다.
정적인 방식의 대표적인 예로는 라운드 로빈과 IP 해시 방식이 있다.
동적인 방식은 서버의 현재 상태에 따라 트래픽을 분산하는 방식으로 트래픽이 적은 서버에 요청을 보내는 형태로 동작한다.
```

### DB 커넥션 풀

1. DB에 연결한다.
2. 쿼리를 실행한다.
3. 사용이 끝나면 연결을 종료한다.

전체 처리 시간 중 80% 이상이 DB의 연결 및 종료에 쓰인다.  
DB 커넥션 풀은 DB에 연결된 커넥션을 미리 생성해서 보관한다.  
이미 연결된 커넥션을 재사용하기 때문에 응답 시간을 효과적으로 줄일 수 있다.  

DB 커넥션 풀은 다양한 설정을 제공한다.  

- 커넥션 풀 크기 (또는 최소 크기, 최대 크기)
- 풀에 커넥션이 없을 때 커넥션을 구할 때까지 대기할 시간
- 커넥션의 유지 시간(최대 유휴 시간, 최대 유지 시간)

### 커넥션 풀 크기

미리 생성해둘 커넥션 갯수를 지정하는 설정이다.  
커넥션 풀 크기보다 큰 요청이 동시에 들어온 경우 초과한 요청에 대해서는  
다른 요청이 커넥션 사용을 끝내고 풀에 반환할 때까지 기다려야 한다.  

전체 응답 시간과 TPS 를 고려하여 커넥션 풀 크기를 지정해야 한다.  
커넥션 풀의 최소 크기가 10이고 최대 크기가 20이라면,  
요청이 10개를 초과하면 커넥션 수를 늘려서 요청을 처리한다.  
최대 20개까지 커넥션을 늘리고 이후 동시 요청이 20개 이하로 줄어들면 커넥션 풀의 커넥션도 점차 줄어든다.  

일반적으로 트래픽은 증가했다가 감소하는 패턴을 보인다.  
트래픽이 순간적으로 급증하는 패턴을 보인다면 커넥션 풀의 최소 크기를 최대 크기에 맞추는 것이 좋다.  

커넥션 풀 크기를 늘리면 처리량을 높일 수 있지만, DB 서버의 CPU 사용률이 80%에 육박하는 상황에서  
커넥션 풀 크기를 늘리면 DB에 가해지는 부하가 더 커져 쿼리 실행 시간이 급격하게 증가할 수 있다.
DB 서버가 포화 상태에 이르지 않도록 주의해야 한다.  

수평 확장<sup>scale-out</sup>하는 것도 커넥션 풀을 늘리는 것과 동일하다.  
DB 서버의 상태를 면밀히 확인한 후에 수평 확장을 진행해야 한다.  

### 커넥션 대기 시간


### 최대 유휴 시간, 유효성 검사, 최대 유지 시간


### 서버 캐시


### 적중률과 삭제 규칙


### 로컬 캐시와 리모트 캐시


### 캐시 사전 적재


### 캐시 무효화


### 가비지 컬렉터와 메모리 사용


### 응답 데이터 압축


### 정적 자원과 브라우저 캐시


### 정적 자원과 CDN


### 대기 처리
